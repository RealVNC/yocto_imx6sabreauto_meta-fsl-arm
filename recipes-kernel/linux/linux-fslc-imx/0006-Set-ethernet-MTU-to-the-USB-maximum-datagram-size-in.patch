From 6adaef2f223035c573151cc40c1baac726051446 Mon Sep 17 00:00:00 2001
From: Yun Jiang <Yun.Jiang@realvnc.com>
Date: Tue, 15 May 2018 09:10:27 +0100
Subject: [PATCH] Set ethernet MTU to the USB maximum datagram size in cdc_ncm
 module by default.

---
 drivers/net/usb/cdc_ncm.c   | 10 +++++++++-
 include/linux/usb/cdc_ncm.h |  2 +-
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/drivers/net/usb/cdc_ncm.c b/drivers/net/usb/cdc_ncm.c
index 5db25e4..ccf84e1 100644
--- a/drivers/net/usb/cdc_ncm.c
+++ b/drivers/net/usb/cdc_ncm.c
@@ -61,6 +61,10 @@ static bool prefer_mbim;
 module_param(prefer_mbim, bool, S_IRUGO | S_IWUSR);
 MODULE_PARM_DESC(prefer_mbim, "Prefer MBIM setting on dual NCM/MBIM functions");
 
+static bool match_mtu = true;
+module_param(match_mtu, bool, S_IRUGO | S_IWUSR);
+MODULE_PARM_DESC(match_mtu, "Set ethernet MTU to the USB maximum datagram size automatically in module loading.");
+
 static void cdc_ncm_txpath_bh(unsigned long param);
 static void cdc_ncm_tx_timeout_start(struct cdc_ncm_ctx *ctx);
 static enum hrtimer_restart cdc_ncm_tx_timer_cb(struct hrtimer *hr_timer);
@@ -551,7 +555,11 @@ static void cdc_ncm_set_dgram_size(struct usbnet *dev, int new_size)
 
 out:
 	/* set MTU to max supported by the device if necessary */
-	dev->net->mtu = min_t(int, dev->net->mtu, ctx->max_datagram_size - cdc_ncm_eth_hlen(dev));
+    if (match_mtu) {
+        dev->net->mtu = ctx->max_datagram_size - cdc_ncm_eth_hlen(dev);
+    } else {
+        dev->net->mtu = min_t(int, dev->net->mtu, ctx->max_datagram_size - cdc_ncm_eth_hlen(dev));
+    }
 
 	/* do not exceed operater preferred MTU */
 	if (ctx->mbim_extended_desc) {
diff --git a/include/linux/usb/cdc_ncm.h b/include/linux/usb/cdc_ncm.h
index e7827ae..fce19c8 100644
--- a/include/linux/usb/cdc_ncm.h
+++ b/include/linux/usb/cdc_ncm.h
@@ -65,7 +65,7 @@
 #define	CDC_NCM_MIN_TX_PKT			512	/* bytes */
 
 /* Default value for MaxDatagramSize */
-#define	CDC_NCM_MAX_DATAGRAM_SIZE		8192	/* bytes */
+#define	CDC_NCM_MAX_DATAGRAM_SIZE		9014 /* bytes */
 
 /*
  * Maximum amount of datagrams in NCM Datagram Pointer Table, not counting
-- 
1.9.1

